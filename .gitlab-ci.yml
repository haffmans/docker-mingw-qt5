stages:
  - mirror
  - build
  - deploy

.prefix-var: &prefix_var
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      variables:
        PREFIX: ""
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
      variables:
        PREFIX: "${CI_COMMIT_REF_NAME}-"

Mirror to github:
  stage: mirror

  image: haffmans/git-mirror:latest
  script:
  - git-mirror "${CI_PROJECT_DIR}" git@github.com:${GITHUB_REPOSITORY}

.build_image: &build_image
  <<: *prefix_var
  stage: build
  script:
  - docker build --pull --target ${TARGET} --tag=${DOCKERHUB_USER}/${DOCKERHUB_REPO}:${PREFIX}${TARGET} .
  tags:
  - docker

Build base:
  <<: *build_image
  variables:
    TARGET: "base"

Build qt5:
  <<: *build_image
  needs: ['Build base']
  variables:
    TARGET: "qt5"

Build qt6:
  <<: *build_image
  needs: ['Build base']
  variables:
    TARGET: "qt6"

.push_image: &push_image
  <<: *prefix_var
  stage: deploy
  script:
  - docker login ${DOCKERHUB_USER} -p ${DOCKERHUB_TOKEN}
  - docker push ${DOCKERHUB_USER}/${DOCKERHUB_REPO}:${PREFIX}${TARGET}
  tags:
  - docker

Push base:
  <<: *push_image
  variables:
    TARGET: "base"

Push qt5:
  <<: *push_image
  variables:
    TARGET: "qt5"

Push qt6:
  <<: *push_image
  variables:
    TARGET: "qt6"
