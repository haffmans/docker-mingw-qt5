stages:
  - mirror
  - build
  - deploy

Mirror to github:
  stage: mirror

  image: haffmans/git-mirror:latest
  script:
  - git-mirror "${CI_PROJECT_DIR}" git@github.com:${GITHUB_REPOSITORY}
  tags:
  - gitmirror

Build master:
  stage: build
  script:
  - docker rmi --force ${DOCKERHUB_USER}/${DOCKERHUB_REPO}:latest || /bin/true
  - docker build --no-cache --tag=${DOCKERHUB_USER}/${DOCKERHUB_REPO}:latest .
  tags:
  - docker
  only:
  - master

Build other:
  stage: build
  script:
  - docker build --no-cache --tag=${DOCKERHUB_USER}/${DOCKERHUB_REPO}:${CI_BUILD_REF_NAME} .
  tags:
  - docker
  except:
  - master

Push master to Docker Hub:
  stage: deploy
  script:
  - docker push ${DOCKERHUB_USER}/${DOCKERHUB_REPO}:latest
  only:
  - master

Push to Docker Hub:
  stage: deploy
  script:
  - docker push ${DOCKERHUB_USER}/${DOCKERHUB_REPO}:${CI_BUILD_REF_NAME}
  except:
  - master
