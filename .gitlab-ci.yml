stages:
  - build
  - deploy

.prefix-var: &prefix_var
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      variables:
        PREFIX: ""
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
      variables:
        PREFIX: "${CI_COMMIT_REF_NAME}-"

.build_image: &build_image
  <<: *prefix_var
  stage: build
  script:
  - docker build --pull --target ${TARGET} --tag=${DOCKERHUB_USER}/${DOCKERHUB_REPO}:${PREFIX}${TARGET} .
  tags:
  - docker

Build base:
  <<: *build_image
  variables:
    TARGET: "base"

Build qt5:
  <<: *build_image
  needs: ['Build base']
  variables:
    TARGET: "qt5"

Build qt6:
  <<: *build_image
  needs: ['Build base']
  variables:
    TARGET: "qt6"

.push_image: &push_image
  <<: *prefix_var
  stage: deploy
  script:
  - docker login -u ${DOCKERHUB_USER} -p ${DOCKERHUB_TOKEN}
  - docker push ${DOCKERHUB_USER}/${DOCKERHUB_REPO}:${PREFIX}${TARGET}
  tags:
  - docker

Push base:
  <<: *push_image
  variables:
    TARGET: "base"

Push qt5:
  <<: *push_image
  variables:
    TARGET: "qt5"

Push qt6:
  <<: *push_image
  variables:
    TARGET: "qt6"

# Tag and push latest (based on qt5, because of the current name) on the default branch too
Tag latest:
  <<: *prefix_var
  rules:
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  script:
  - docker tag ${DOCKERHUB_USER}/${DOCKERHUB_REPO}:${PREFIX}qt5 ${DOCKERHUB_USER}/${DOCKERHUB_REPO}:${PREFIX}latest
  tags:
  - docker
  stage: deploy

Push latest:
  <<: *push_image
  rules:
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  dependencies:
  - "Tag latest"
  - "Push qt5"
  variables:
    TARGET: "latest"
